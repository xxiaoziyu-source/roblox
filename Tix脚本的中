-- ä¿®æ­£åçš„ TXRè„šæœ¬éªŒè¯æ ¸å¿ƒé€»è¾‘
-- ä¿®å¤äº†è¯­æ³•é”™è¯¯å’Œé€»è¾‘é—®é¢˜ï¼Œä¿æŒåŸæœ‰åŠŸèƒ½

-----------------------------------------------------------
-- TXRè„šæœ¬éªŒè¯æ ¸å¿ƒé€»è¾‘ï¼ˆLocalScriptï¼Œé€‚é…å¤šæ³¨å…¥å™¨ï¼‰
-- éªŒè¯æ ‡è®°ï¼šæ³¨å…¥å™¨æŒä¹…åŒ–ç›®å½•ä¸‹çš„"åŒæ„TXRè„šæœ¬"æ–‡ä»¶å¤¹
-----------------------------------------------------------
-- ================ åŸºç¡€æœåŠ¡ä¸å˜é‡ ================
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer or Players.PlayerAdded:Wait()
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local RunService = game:GetService("RunService")
local Color3 = Color3
local UDim2 = UDim2
local Instance = Instance
local task = task
local Enum = Enum

-- æ³¨å…¥å™¨æ–‡ä»¶æ“ä½œå…¼å®¹ï¼ˆæ ¸å¿ƒï¼šè·å–æŒä¹…åŒ–è·¯å¾„ï¼‰
local readFunc, writeFunc, getPathFunc
pcall(function()
    -- é€‚é…å¿è€…/Delta/Synapseç­‰æ³¨å…¥å™¨
    if type(syn) == "table" then
        readFunc = syn.readfile or readfile
        writeFunc = syn.writefile or writefile
        getPathFunc = syn.datapath  -- å¿è€…æ³¨å…¥å™¨è·å–æ²™ç›’è·¯å¾„
    else
        -- å…¶ä»–æ³¨å…¥å™¨å…¼å®¹
        readFunc = readfile or readFile
        writeFunc = writefile or writeFile
        -- å°è¯•è·å–é»˜è®¤è·¯å¾„ï¼ˆå¦‚Krnlç­‰ï¼‰
        getPathFunc = function() return "Roblox/Scripts" end
    end
end)

-- ================ éªŒè¯æ–‡ä»¶å¤¹æ ¸å¿ƒé€»è¾‘ ================
-- è·å–æŒä¹…åŒ–æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆè·¨æ³¨å…¥å™¨å…¼å®¹ï¼‰
local function getVerifyFolderPath()
    local basePath
    if getPathFunc then
        -- ä¼˜å…ˆä½¿ç”¨æ³¨å…¥å™¨æä¾›çš„æ²™ç›’è·¯å¾„ï¼ˆå¦‚å¿è€…çš„syn.datapath()ï¼‰
        basePath = getPathFunc()
    else
        -- fallbackè·¯å¾„ï¼ˆé€‚é…å¤šæ•°PCæ³¨å…¥å™¨ï¼‰
        basePath = "C:/RobloxScripts"  -- å¯æ ¹æ®ç³»ç»Ÿè‡ªåŠ¨è°ƒæ•´
        pcall(function()
            -- å°è¯•æ£€æµ‹ç³»ç»Ÿç±»å‹ï¼ˆWindows/macOSï¼‰
            if game:GetService("RunService"):IsStudio() then
                basePath = "Roblox/Scripts"  -- Studioç¯å¢ƒ
            elseif string.find(game:GetService("MarketplaceService"):GetProductInfo(1).Name or "", "Mac") then
                basePath = "~/Library/Roblox/Scripts"  -- macOSè·¯å¾„
            end
        end)
    end
    -- æ‹¼æ¥å®Œæ•´æ–‡ä»¶å¤¹è·¯å¾„
    return basePath .. "/åŒæ„TXRè„šæœ¬"
end

-- æ£€æŸ¥æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨ï¼ˆè·¨æ³¨å…¥å™¨å…¼å®¹ï¼‰
local function folderExists()
    if not readFunc then return false end  -- æ— æ–‡ä»¶æ“ä½œèƒ½åŠ›åˆ™å¼ºåˆ¶éªŒè¯
    local folderPath = getVerifyFolderPath()
    -- å°è¯•è¯»å–æ–‡ä»¶å¤¹ï¼ˆæ³¨å…¥å™¨é€šå¸¸é€šè¿‡æ£€æŸ¥è·¯å¾„æ˜¯å¦å¯è®¿é—®åˆ¤æ–­å­˜åœ¨æ€§ï¼‰
    local success = pcall(function()
        -- ä¸åŒæ³¨å…¥å™¨åˆ¤æ–­æ–¹å¼å¯èƒ½ä¸åŒï¼Œè¿™é‡Œç”¨"å°è¯•è¯»å–"ä½œä¸ºå­˜åœ¨æ€§æ£€æµ‹
        readFunc(folderPath .. "/.verify")  -- è¯»å–æ–‡ä»¶å¤¹å†…çš„æ ‡è®°æ–‡ä»¶
    end)
    return success
end

-- åˆ›å»ºéªŒè¯æ–‡ä»¶å¤¹ï¼ˆè·¨æ³¨å…¥å™¨å…¼å®¹ï¼‰
local function createTargetFolder()
    if not writeFunc then return end  -- æ— å†™å…¥èƒ½åŠ›åˆ™è·³è¿‡ï¼ˆä¸å½±å“ä½¿ç”¨ï¼Œä»…ä¸‹æ¬¡ä»éœ€éªŒè¯ï¼‰
    local folderPath = getVerifyFolderPath()
    local success = pcall(function()
        -- 1. åˆ›å»ºæ–‡ä»¶å¤¹ï¼ˆæ³¨å…¥å™¨é€šå¸¸æ”¯æŒé€šè¿‡å†™å…¥ç©ºæ–‡ä»¶åˆ›å»ºæ–‡ä»¶å¤¹ï¼‰
        writeFunc(folderPath .. "/.verify", "")  -- å†™å…¥ç©ºæ ‡è®°æ–‡ä»¶ï¼Œè‡ªåŠ¨åˆ›å»ºçˆ¶æ–‡ä»¶å¤¹
        print("éªŒè¯æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸï¼š" .. folderPath)
    end)
    if not success then
        -- é™çº§æ–¹æ¡ˆï¼šè‹¥æ— æ³•åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œä¸´æ—¶ç”¨PlayerGuiæ–‡ä»¶å¤¹ï¼ˆä»…å½“å‰ä¼šè¯æœ‰æ•ˆï¼‰
        local tempFolder = Instance.new("Folder")
        tempFolder.Name = "åŒæ„ç§‹å®¹è„šæœ¬"
        tempFolder.Parent = PlayerGui
        print("è­¦å‘Šï¼šæŒä¹…åŒ–æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥ï¼Œä½¿ç”¨ä¸´æ—¶æ–‡ä»¶å¤¹ï¼ˆä»…å½“å‰ä¼šè¯æœ‰æ•ˆï¼‰")
    end
end

-- ================ é€šç”¨UIå·¥å…·å‡½æ•° ================
-- åˆ›å»ºå±å¹•GUI
local function createScreenGui(name)
    local gui = Instance.new("ScreenGui")
    gui.Name = name
    gui.IgnoreGuiInset = true
    gui.Parent = PlayerGui
    return gui
end

-- åˆ›å»ºå¸¦åœ†è§’çš„æ¡†æ¶
local function createFrame(parent, size, position)
    local frame = Instance.new("Frame")
    frame.Size = size
    frame.Position = position
    frame.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    frame.BackgroundTransparency = 0.3
    frame.BorderSizePixel = 1
    frame.BorderColor3 = Color3.fromRGB(180, 160, 255)
    frame.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = frame
    
    return frame
end

-- åˆ›å»ºåŸºç¡€æ ‡ç­¾
local function createBasicLabel(parent, text, size, position)
    local label = Instance.new("TextLabel")
    label.Text = text
    label.Size = size
    label.Position = position
    label.TextColor3 = Color3.new(1, 1, 1)
    label.TextSize = 16
    label.BackgroundTransparency = 1
    label.Parent = parent
    return label
end

-- åˆ›å»ºæ™®é€šæ ‡ç­¾
local function createLabel(parent, text, size, position)
    local label = Instance.new("TextLabel")
    label.Text = text
    label.Size = size
    label.Position = position
    label.TextColor3 = Color3.new(1, 1, 1)
    label.TextSize = 16
    label.BackgroundTransparency = 1
    label.Parent = parent
    return label
end

-- åˆ›å»ºæŒ‰é’®
local function createButton(parent, text, size, position, callback)
    local btn = Instance.new("TextButton")
    btn.Text = text
    btn.Size = size
    btn.Position = position
    btn.BackgroundColor3 = Color3.fromRGB(60, 60, 100)
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.TextSize = 14
    btn.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = btn
    
    if callback then
        btn.MouseButton1Click:Connect(callback)
    end
    return btn
end

-- åˆ›å»ºç‚¹å‡»è¾“å…¥æ¡†
local function createClickToInput(parent, size, position, triggerText, placeholderText)
    local trigger = Instance.new("TextButton")
    trigger.Size = size
    trigger.Position = position
    trigger.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
    trigger.BackgroundTransparency = 0.7
    trigger.Text = triggerText
    trigger.TextColor3 = Color3.new(1, 1, 1)
    trigger.TextSize = 14
    trigger.Parent = parent
    
    local cornerTrigger = Instance.new("UICorner")
    cornerTrigger.CornerRadius = UDim.new(0, 6)
    cornerTrigger.Parent = trigger
    
    local box = Instance.new("TextBox")
    box.Size = size
    box.Position = position
    box.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
    box.BackgroundTransparency = 0.7
    box.TextColor3 = Color3.new(1, 1, 1)
    box.TextSize = 14
    box.PlaceholderText = placeholderText
    box.Visible = false
    box.Parent = parent
    
    local cornerBox = Instance.new("UICorner")
    cornerBox.CornerRadius = UDim.new(0, 6)
    cornerBox.Parent = box
    
    trigger.MouseButton1Click:Connect(function()
        trigger.Visible = false
        box.Visible = true
        box:CaptureFocus()
    end)
    
    return trigger, box
end

-- æ’­æ”¾ä¸´æ—¶éŸ³æ•ˆ
local function playTempSound(soundId)
    local fullSoundId = "rbxassetid://" .. tostring(soundId)
    local sound = Instance.new("Sound")
    sound.SoundId = fullSoundId
    sound.Volume = 1.0
    sound.Parent = workspace
    pcall(function()
        sound:Play()
        sound.Ended:Connect(function() sound:Destroy() end)
        task.delay(5, function() if sound.Parent then sound:Destroy() end end)
    end)
end

-- ================ éªŒè¯å¼¹çª—é€»è¾‘ ================
-- å¿«æ‰‹å·éªŒè¯
local function Popup_VerifyKuaishou()
    local gui = createScreenGui("Popup_Kuaishou")
    local frame = createFrame(gui, UDim2.new(0, 420, 0, 240), UDim2.new(0.5, -210, 0.5, -120))
    createLabel(frame, "è¯·è¾“å…¥ä½ çš„å¡å¯†", UDim2.new(1, 0, 0, 35), UDim2.new(0, 0, 0, 25))
    
    local _, inputKuaishou = createClickToInput(
        frame, UDim2.new(1, -50, 0, 45), UDim2.new(0, 25, 0, 75),
        "ç‚¹å‡»è¾“å…¥å¡å¯†", "è¯·è¾“å…¥æ­£ç¡®çš„å¡å¯†"
    )
    
    local statusLabel = createLabel(frame, "", UDim2.new(1, 0, 0, 25), UDim2.new(0, 0, 0, 135))
    local done = false
    
    createButton(frame, "éªŒè¯ä½ çš„å¡å¯†", UDim2.new(0.45, 0, 0, 35), UDim2.new(0.1, 0, 0, 175), function()
        if inputKuaishou.Text == "TXR" then
            done = true
            gui:Destroy()
        else
            statusLabel.Text = "å¡å¯†é”™è¯¯"
            statusLabel.TextColor3 = Color3.fromRGB(255, 60, 60)
        end
    end)
    
    createButton(frame, "é€€å‡ºè„šæœ¬", UDim2.new(0.45, 0, 0, 35), UDim2.new(0.5, 0, 0, 175), function()
        gui:Destroy()
        error("ç”¨æˆ·ä¸»åŠ¨é€€å‡ºï¼Œè„šæœ¬åœæ­¢è¿è¡Œ")
    end)
    
    while not done do task.wait() end
end

-- QQç¾¤éªŒè¯
local function Popup_VerifyQQGroup()
    local gui = createScreenGui("Popup_QQGroup")
    local frame = createFrame(gui, UDim2.new(0, 420, 0, 260), UDim2.new(0.5, -210, 0.5, -130))
    createLabel(frame, "ä¸»æ’­ç°åœ¨è¿˜æœ‰æ²¡æœ‰QQç¾¤ï¼Ÿ", UDim2.new(1, 0, 0, 35), UDim2.new(0, 0, 0, 25))
    
    local _, inputQQGroup = createClickToInput(
        frame, UDim2.new(1, -50, 0, 45), UDim2.new(0, 25, 0, 75),
        "ç‚¹å‡»è¾“å…¥ç­”æ¡ˆ", "è¯·è¾“å…¥æœ‰æˆ–è€…æ²¡æœ‰"
    )
    
    local statusLabel = createLabel(frame, "", UDim2.new(1, 0, 0, 25), UDim2.new(0, 0, 0, 135))
    local exitCount = 0
    local done = false
    
    createButton(frame, "æœ‰QQ", UDim2.new(0.45, 0, 0, 35), UDim2.new(0.1, 0, 0, 185), function()
        statusLabel.Text = "ä½ æ˜¯åºŸç‰©å—ï¼Ÿè¿™éƒ½ç­”ä¸ä¸Šæ¥"
        statusLabel.TextColor3 = Color3.fromRGB(255, 60, 60)
    end)
    
    createButton(frame, "ç°å…ç‰ˆè„šæœ¬", UDim2.new(0.45, 0, 0, 35), UDim2.new(0.5, 0, 0, 185), function()
        exitCount = exitCount + 1
        if exitCount == 1 then
            statusLabel.Text = "åŠ è½½ä¸­"
            statusLabel.TextColor3 = Color3.fromRGB(255, 220, 60)
        elseif exitCount >= 2 then
            done = true
            gui:Destroy()
        end
    end)
    
    while not done do task.wait() end
    
    -- æœ€ç»ˆæç¤º
    local notifyGui = createScreenGui("Popup_FinalNotice")
    local notifyFrame = createFrame(notifyGui, UDim2.new(0, 340, 0, 120), UDim2.new(0.5, -170, 0.5, -60))
    createLabel(notifyFrame, "è¯·è´­ä¹°å¡å¯†", UDim2.new(1, 0, 0, 35), UDim2.new(0, 0, 0, 45))
    playTempSound("12222253")
    task.wait(3)
    notifyGui:Destroy()
end

-- ================ å…¬å‘Šå¼¹çª—ï¼ˆæ·»åŠ æ»šåŠ¨åŠŸèƒ½ï¼‰ ================
local function showAnnouncement()
    local noticeGui = createScreenGui("Popup_Announcement")
    local noticeFrame = createFrame(noticeGui, UDim2.new(0, 400, 0, 300), UDim2.new(0.5, -200, 0.5, -150))
    
    -- æ ‡é¢˜ï¼ˆç¼©å°50%ï¼šåŸ22 â†’ 11ï¼‰
    local titleLabel = createBasicLabel(noticeFrame, "3.1æ±‰åŒ–ç‰ˆ è„šæœ¬å…¬å‘Š", UDim2.new(1, 0, 0, 40), UDim2.new(0, 0, 0, 15))
    titleLabel.TextSize = 22 * 0.5  -- ä»…å…¬å‘Šæ ‡é¢˜ç¼©å°
    titleLabel.TextColor3 = Color3.fromRGB(255, 210, 0)
    titleLabel.TextXAlignment = Enum.TextXAlignment.Center
    
    -- åˆ›å»ºæ»šåŠ¨æ¡†æ¶
    local scrollFrame = Instance.new("ScrollingFrame")
    scrollFrame.Name = "AnnouncementScroll"
    scrollFrame.Size = UDim2.new(1, -20, 0, 180)
    scrollFrame.Position = UDim2.new(0, 10, 0, 60)
    scrollFrame.BackgroundTransparency = 1
    scrollFrame.ScrollBarThickness = 8
    scrollFrame.ScrollingDirection = Enum.ScrollingDirection.Y
    scrollFrame.Parent = noticeFrame
    
    -- å†…å®¹æ ‡ç­¾ï¼ˆæ”¾åœ¨æ»šåŠ¨æ¡†æ¶å†…ï¼‰
    local contentLabel = createLabel(scrollFrame, "æ›´æ–°æ—¥å¿—:\n8æœˆ21æ—¥05:35æ›´æ–°å†›äº‹å¤§äº¨å»é™¤GBå¤±æ•ˆè„šæœ¬å…¨è‡ªåŠ¨å†œåœºè„šæœ¬æŒ‚æœºå³å¯\n8æœˆ21æ—¥10:07æ›´æ–°å¢¨æ°´æ¸¸æˆæ–°ç‰ˆè€å¤–XaåŒ…æ‹¬ä½¿ç”¨æ•™ç¨‹è·å–æ–¹æ³•å’Œæ³¨æ„äº‹é¡¹\n8æœˆ21æ—¥00:58æ›´æ–°WARMIX[PVP FPS æ­¦å™¨æˆ˜æ–—å°„å‡»æª]-ä¿æŠ¤æˆ¿å±‹å…å—æ€ªç‰©ä¾µå®³-ä¿æŠ¤æ€»ç»Ÿ\n8æœˆ22æ—¥18:17æ·»åŠ äº†chainæœåŠ¡å™¨è„šæœ¬\n9æœˆ12æ—¥æ›´æ–°å¢¨æ°´æ¸¸æˆæ±‰åŒ–è„šç›®å‰ä½œè€…å·²å­¦ä¼šæ±‰åŒ–é€æ¸æ±‰åŒ–ä¸­\n9æœˆ13æ—¥10:00æ›´æ–°æ–°çš„å¢¨æ°´æ¸¸æˆæ±‰åŒ–å»é™¤å¢¨æ°´æ¸¸æˆè¿‡æœŸè„šæœ¬å»é™¤ink-gameæ­£å¸¸ç‰ˆæ·»åŠ ink-gameæµ‹è¯•ç‰ˆæ±‰åŒ–\n9æœˆ13æ—¥16:12å…¨é¢å–æ¶ˆæ±‰åŒ–æ›´æ–°æ–°çš„æ–¹æ³•ç­‰å¾…åŠå¤©æ–°æ›´æ–°äº†Xaé“¾æ¥ä¿®å¤è¿‡æœŸ\n9æœˆ13æ—¥23:08æ›´æ–°ä¸€é”®æ±‰åŒ–è„šæœ¬æ‰“å¼€è„šæœ¬ç‚¹å‡»æŒ‰é’®å°†è¿›è¡Œæ±‰åŒ–ç›®å‰åªæ”¯æŒå¢¨æ°´æ¸¸æˆaxæˆ–ink-gameå’ŒRINGTAä¸€é”®æ±‰åŒ–è„šæœ¬åœ¨å¢¨æ°´æ¸¸æˆèœå•(ç¦æ­¢æ‹¿å»åœˆğŸ’°å°¤å…¶æ˜¯çŸ¥é“æºç åœ°å€çš„äºº)\n9æœˆ14æ—¥12:23æ·»åŠ äº†æœ€å¼ºæˆ˜åœºæ±‰åŒ–è¿˜æ˜¯åœ¨ä¸€é”®æ±‰åŒ–è„šæœ¬é‡Œé¢ï¼Œè¿˜æ˜¯åœ¨å¢¨æ°´èœå•", 
        UDim2.new(1, -10, 0, 0), UDim2.new(0, 5, 0, 5))
    contentLabel.TextSize = 16 * 0.5  -- ä»…å…¬å‘Šå†…å®¹ç¼©å°
    contentLabel.TextWrapped = true
    contentLabel.TextXAlignment = Enum.TextXAlignment.Left
    contentLabel.AutomaticSize = Enum.AutomaticSize.Y
    
    -- è®¾ç½®æ»šåŠ¨æ¡†æ¶çš„CanvasSize
    contentLabel:GetPropertyChangedSignal("TextBounds"):Connect(function()
        scrollFrame.CanvasSize = UDim2.new(0, 0, 0, contentLabel.TextBounds.Y + 10)
    end)
    
    -- å…³é—­æŒ‰é’®
    local noticeDone = false
    createButton(noticeFrame, "æˆ‘çŸ¥é“äº†", UDim2.new(0.5, 0, 0, 40), UDim2.new(0.25, 0, 1, -50), function()
        noticeDone = true
        noticeGui:Destroy()
    end)
    
    while not noticeDone do task.wait() end
end

-- ================ æ‰§è¡Œæµç¨‹ ================
local isFirstUse = not folderExists()  -- æ£€æµ‹æŒä¹…åŒ–æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
if isFirstUse then
    -- é¦–æ¬¡ä½¿ç”¨ï¼šæ‰§è¡ŒéªŒè¯ â†’ åˆ›å»ºæŒä¹…åŒ–æ–‡ä»¶å¤¹ â†’ æ˜¾ç¤ºå…¬å‘Š
    Popup_VerifyKuaishou()
    Popup_VerifyQQGroup()
    createTargetFolder()  -- éªŒè¯é€šè¿‡ååˆ›å»ºæ–‡ä»¶å¤¹ï¼ˆè·¨ä¼šè¯ä¿ç•™ï¼‰
    showAnnouncement()
else
    -- éé¦–æ¬¡ä½¿ç”¨ï¼šç›´æ¥æ˜¾ç¤ºå…¬å‘Šï¼ˆè·³è¿‡éªŒè¯ï¼‰
    print("æ£€æµ‹åˆ°éªŒè¯æ–‡ä»¶å¤¹ï¼Œè·³è¿‡éªŒè¯")
    showAnnouncement()
end

-- ================ ä¸»UIç³»ç»Ÿï¼ˆä¿®å¤ç‰ˆï¼‰ ================
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")
local SoundService = game:GetService("SoundService")
local HttpService = game:GetService("HttpService")

-- ====================== é…ç½®ä¸çŠ¶æ€ç®¡ç† ======================
local CONFIG = {
    TWEEN_DURATION = 0.25,
    UPDATE_INTERVAL = 0.5,
    UI_SCALE = { default = 0.8 },
    UI_COLORS = {
        primary = Color3.fromRGB(60, 60, 100),
        secondary = Color3.fromRGB(50, 50, 70),
        accent = Color3.fromRGB(255, 230, 100),
        success = Color3.fromRGB(60, 100, 80),
        danger = Color3.fromRGB(150, 50, 50),
        localPlayer = Color3.fromRGB(100, 200, 255)
    },
    NOTIFICATION = {
        DURATION = 3,
        SOUND_ID = "79348298352567",
        CORNER_RADIUS = 12
    }
}

local UI_STATE = {
    scale = CONFIG.UI_SCALE.default,
    activeMenu = "ä¿å­˜ä½ç½®",
    menuPanels = {},
    isRunning = true,
    isScaling = false,
    mainPanel = nil,
    floatBtn = nil,
    topBar = nil,
    isDragging = false,
    isScrolling = false,
    dragStart = Vector2.new(0, 0),
    panelStartPos = UDim2.new(0, 0, 0, 0),
    scrollStartPositions = {},
    savedCoordinates = {},
    csvFilePath = "",
    coordinateLoop = nil,
    playerPositionLoop = nil,
    playerSortMode = "name",
    isToggleFeatureEnabled = false,
    wallhackConnection = nil,
    characterAddedConn = nil,
    characterRemovingConn = nil
}

-- ====================== å·¥å…·å‡½æ•° ======================
-- åˆ›å»ºåœ†è§’
local function createCorner(parent, radius)
    if not parent or not parent:IsDescendantOf(game) then return end
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, radius * UI_STATE.scale)
    corner.Parent = parent
end

-- åˆ›å»ºæ–‡æœ¬æ ‡ç­¾
local function createUILabel(parent, props)
    if not parent or not parent:IsDescendantOf(game) then return nil end
    local label = Instance.new("TextLabel")
    label.Name = props.name or "Label"
    label.Size = props.size or UDim2.new(1, 0, 1, 0)
    label.Position = props.position or UDim2.new(0, 0, 0, 0)
    label.Text = props.text or ""
    label.TextColor3 = props.color or Color3.new(1, 1, 1)
    label.TextSize = (props.textSize or 14) * UI_STATE.scale
    label.TextXAlignment = props.xAlign or Enum.TextXAlignment.Left
    label.BackgroundTransparency = props.bgTransparency or 1
    label.BackgroundColor3 = props.bgColor or Color3.new(0, 0, 0)
    label.Font = props.font or Enum.Font.SourceSans
    label.Parent = parent
    label.Active = props.active or false
    
    if props.anchor then
        label.AnchorPoint = props.anchor
    end
    if props.textWrapped then
        label.TextWrapped = true
    end
    
    return label
end

-- åˆ›å»ºæŒ‰é’®
local function createUIButton(parent, props)
    if not parent or not parent:IsDescendantOf(game) then return nil end
    local btn = Instance.new("TextButton")
    btn.Name = props.name or "Button"
    btn.Size = props.size or UDim2.new(1, 0, 0, 40 * UI_STATE.scale)
    btn.Position = props.position or UDim2.new(0, 0, 0, 0)
    btn.Text = props.text or "æŒ‰é’®"
    btn.TextColor3 = props.textColor or Color3.new(1, 1, 1)
    btn.TextSize = (props.textSize or 16) * UI_STATE.scale
    btn.BackgroundColor3 = props.bgColor or CONFIG.UI_COLORS.primary
    btn.BackgroundTransparency = props.bgTransparency or 0.8
    btn.Parent = parent
    btn.Active = props.active ~= nil and props.active or true
    btn.Selectable = props.selectable or false
    
    if props.anchor then
        btn.AnchorPoint = props.anchor
    end
    
    createCorner(btn, props.radius or 8)
    
    -- æ‚¬åœåŠ¨ç”»
    if props.hoverColor then
        btn.MouseEnter:Connect(function()
            if not UI_STATE.isDragging and not UI_STATE.isScrolling and btn:IsDescendantOf(game) then
                TweenService:Create(
                    btn,
                    TweenInfo.new(CONFIG.TWEEN_DURATION),
                    {BackgroundColor3 = props.hoverColor}
                ):Play()
            end
        end)
        btn.MouseLeave:Connect(function()
            if not UI_STATE.isDragging and not UI_STATE.isScrolling and btn:IsDescendantOf(game) then
                TweenService:Create(
                    btn,
                    TweenInfo.new(CONFIG.TWEEN_DURATION),
                    {BackgroundColor3 = props.bgColor or CONFIG.UI_COLORS.primary}
                ):Play()
            end
        end)
    end
    
    -- ç‚¹å‡»äº‹ä»¶
    if props.onClick then
        btn.MouseButton1Click:Connect(function()
            task.defer(function()
                if not UI_STATE.isDragging and not UI_STATE.isScrolling and btn:IsDescendantOf(game) then
                    props.onClick()
                end
            end)
        end)
    end
    
    return btn
end

-- æ˜¾ç¤ºé€šçŸ¥
local function showNotification(title, text, duration)
    local localPlayer = Players.LocalPlayer
    if not localPlayer then return end
    local playerGui = localPlayer:FindFirstChild("PlayerGui")
    if not playerGui then return end
    
    -- ç®€å•é€šçŸ¥å®ç°
    local notificationGui = Instance.new("ScreenGui")
    notificationGui.Name = "CustomNotification"
    notificationGui.Parent = playerGui
    
    local notificationFrame = Instance.new("Frame")
    notificationFrame.Size = UDim2.new(0, 200, 0, 80)
    notificationFrame.Position = UDim2.new(1, -210, 1, -90)
    notificationFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    notificationFrame.BackgroundTransparency = 0.2
    notificationFrame.Parent = notificationGui
    
    createCorner(notificationFrame, 8)
    
    local titleLabel = createUILabel(notificationFrame, {
        text = title or "æç¤º",
        size = UDim2.new(1, -10, 0, 25),
        position = UDim2.new(0, 5, 0, 5),
        color = Color3.fromRGB(255, 230, 100),
        textSize = 14,
        xAlign = Enum.TextXAlignment.Center
    })
    
    local contentLabel = createUILabel(notificationFrame, {
        text = text or "",
        size = UDim2.new(1, -10, 0, 40),
        position = UDim2.new(0, 5, 0, 30),
        color = Color3.new(1, 1, 1),
        textSize = 12,
        textWrapped = true,
        xAlign = Enum.TextXAlignment.Center
    })
    
    -- è‡ªåŠ¨é”€æ¯
    task.delay(duration or CONFIG.NOTIFICATION.DURATION, function()
        if notificationGui and notificationGui.Parent then
            notificationGui:Destroy()
        end
    end)
end

-- æ‹–åŠ¨ç»‘å®šå‡½æ•°
local function bindDragToElement(element, target)
    if not element or not target then return end
    element.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or 
           input.UserInputType == Enum.UserInputType.Touch then
            UI_STATE.isDragging = true
            UI_STATE.dragStart = input.Position
            UI_STATE.panelStartPos = target.Position
        end
    end)
end

-- UIæ¸…ç†å‡½æ•°
local function cleanupOldUI()
    local localPlayer = Players.LocalPlayer
    if not localPlayer then return end
    local playerGui = localPlayer:FindFirstChild("PlayerGui")
    if not playerGui then return end
    
    -- æ¸…ç†ä¸»UI
    if UI_STATE.mainPanel and UI_STATE.mainPanel:IsDescendantOf(game) then
        UI_STATE.mainPanel:Destroy()
    end
    
    -- æ¸…ç†æ‚¬æµ®çª—
    if UI_STATE.floatBtn and UI_STATE.floatBtn:IsDescendantOf(game) then
        UI_STATE.floatBtn:Destroy()
    end
    
    -- æ¸…ç†é€šçŸ¥å’Œå¯¹è¯æ¡†
    for _, gui in ipairs(playerGui:GetChildren()) do
        if gui.Name:match("CustomNotification") or gui.Name == "ExecutionDialog" then
            gui:Destroy()
        end
    end
    
    -- æ–­å¼€å¾ªç¯
        -- æ–­å¼€å¾ªç¯
    if UI_STATE.coordinateLoop then
        UI_STATE.coordinateLoop:Disconnect()
        UI_STATE.coordinateLoop = nil
    end
    if UI_STATE.playerPositionLoop then
        UI_STATE.playerPositionLoop:Disconnect()
        UI_STATE.playerPositionLoop = nil
    end
    
    -- æ–­å¼€è§’è‰²ç›‘å¬è¿æ¥
    if UI_STATE.characterAddedConn then
        UI_STATE.characterAddedConn:Disconnect()
        UI_STATE.characterAddedConn = nil
    end
    if UI_STATE.characterRemovingConn then
        UI_STATE.characterRemovingConn:Disconnect()
        UI_STATE.characterRemovingConn = nil
    end
    
    -- æ–­å¼€ç©¿å¢™åŠŸèƒ½è¿æ¥
    if UI_STATE.wallhackConnection then
        UI_STATE.wallhackConnection:Disconnect()
        UI_STATE.wallhackConnection = nil
    end
end

-- è§’è‰²é”€æ¯æ—¶çš„æ¸…ç†å‡½æ•°
local function onCharacterRemoving()
    -- æ–­å¼€åæ ‡æ›´æ–°å¾ªç¯
    if UI_STATE.coordinateLoop then
        UI_STATE.coordinateLoop:Disconnect()
        UI_STATE.coordinateLoop = nil
    end
    -- æ–­å¼€ç©å®¶ä½ç½®æ›´æ–°å¾ªç¯
    if UI_STATE.playerPositionLoop then
        UI_STATE.playerPositionLoop:Disconnect()
        UI_STATE.playerPositionLoop = nil
    end
    -- æ–­å¼€ç©¿å¢™åŠŸèƒ½è¿æ¥
    if UI_STATE.wallhackConnection then
        UI_STATE.wallhackConnection:Disconnect()
        UI_STATE.wallhackConnection = nil
    end
    showNotification("è§’è‰²å·²é”€æ¯", "è„šæœ¬å·²æš‚åœï¼Œç­‰å¾…è§’è‰²é‡ç”Ÿ...")
end

-- è§’è‰²é‡ç”Ÿæ—¶çš„åˆå§‹åŒ–å‡½æ•°
local function onCharacterAdded(character)
    -- ç­‰å¾…è§’è‰²åŠ è½½å®Œæˆ
    local rootPart = character:WaitForChild("HumanoidRootPart", 10)
    local humanoid = character:WaitForChild("Humanoid", 10)
    
    if not rootPart or not humanoid then
        showNotification("è§’è‰²åŠ è½½å¤±è´¥", "æ— æ³•è·å–è§’è‰²å…³é”®éƒ¨ä»¶")
        return
    end
    
    -- é‡æ–°å¯åŠ¨åæ ‡æ›´æ–°ï¼ˆå¦‚æœå½“å‰åœ¨ä¿å­˜ä½ç½®èœå•ï¼‰
    if UI_STATE.activeMenu == "ä¿å­˜ä½ç½®" and UI_STATE.mainPanel and UI_STATE.mainPanel.Visible then
        if UI_STATE.coordinateLoop then
            UI_STATE.coordinateLoop:Disconnect()
        end
        UI_STATE.coordinateLoop = RunService.Heartbeat:Connect(function()
            local root = character:FindFirstChild("HumanoidRootPart")
            if root then
                local pos = root.Position
                local coordLabel = UI_STATE.mainPanel:FindFirstChild("CoordDisplay", true)
                if coordLabel then
                    coordLabel.Text = string.format("å®æ—¶åæ ‡ï¼šX: %.1f, Y: %.1f, Z: %.1f", pos.X, pos.Y, pos.Z)
                end
            end
        end)
    end
    
    -- ç›‘å¬è§’è‰²æ­»äº¡äº‹ä»¶
    humanoid.Died:Connect(function()
        onCharacterRemoving()
    end)
    
    showNotification("è§’è‰²å·²åŠ è½½", "è„šæœ¬åŠŸèƒ½å·²æ¢å¤")
end

-- ====================== æ–‡ä»¶è¯»å†™ ======================
local function initCSVPath()
    print("åˆå§‹åŒ–CSVè·¯å¾„...")
    local success, result = pcall(function()
        -- å¿è€…æ³¨å…¥å™¨è·¯å¾„é€‚é…
        if type(syn) == "table" then
            return syn.datapath and syn.datapath() .. "/Roblox_Current_Coord.csv" 
                or "/sdcard/Delta/Scripts/Roblox_Current_Coord.csv"
        else
            return "Roblox_Current_Coord.csv"
        end
    end)
    UI_STATE.csvFilePath = success and result or "Roblox_Current_Coord.csv"
    print("åæ ‡æ–‡ä»¶è·¯å¾„ï¼š", UI_STATE.csvFilePath)
end

local function readCSVFile()
    print("è¯»å–åæ ‡æ–‡ä»¶ï¼š", UI_STATE.csvFilePath)
    if not readFunc then
        warn("å½“å‰æ³¨å…¥å™¨ä¸æ”¯æŒæ–‡ä»¶è¯»å–ï¼Œå°†ä½¿ç”¨ç©ºåæ ‡åˆ—è¡¨")
        return {}
    end
    local success, content = pcall(readFunc, UI_STATE.csvFilePath)
    if not success or not content or content == "" then
        print("åæ ‡æ–‡ä»¶è¯»å–å¤±è´¥ï¼ˆç©ºåˆ—è¡¨ï¼‰ï¼š", success and content or "æ— å†…å®¹")
        return {}
    end
    local coords = {}
    local lines = content:split("\n")
    for i = 2, #lines do
        local line = lines[i]:gsub("\r", "")
        if line ~= "" then
            local safeLine = line:gsub("\\,", "\0")
            local parts = safeLine:split(",")
            if #parts == 4 then
                local name = parts[1]:gsub("\0", ",")
                local x, y, z = tonumber(parts[2]), tonumber(parts[3]), tonumber(parts[4])
                if x and y and z then
                    x = math.round(x * 100) / 100
                    y = math.round(y * 100) / 100
                    z = math.round(z * 100) / 100
                    table.insert(coords, {name = name, x = x, y = y, z = z})
                end
            end
        end
    end
    print("è¯»å–åˆ°", #coords, "æ¡åæ ‡")
    return coords
end

local function updateCSVFile()
    if not writeFunc then
        warn("å½“å‰æ³¨å…¥å™¨ä¸æ”¯æŒæ–‡ä»¶å†™å…¥")
        return false
    end
    local csv = "åç§°,Xåæ ‡,Yåæ ‡,Zåæ ‡\n"
    for _, coord in ipairs(UI_STATE.savedCoordinates) do
        local safeName = coord.name:gsub(",", "\\,")
        csv = csv .. string.format("%s,%.2f,%.2f,%.2f\n", safeName, coord.x, coord.y, coord.z)
    end
    local success, err = pcall(writeFunc, UI_STATE.csvFilePath, csv)
    if not success then
        warn("åæ ‡å†™å…¥å¤±è´¥: " .. tostring(err))
        return false
    end
    print("åæ ‡æ–‡ä»¶å·²æ›´æ–°")
    return true
end

-- ====================== æ‚¬æµ®çª—åˆ›å»º ======================
local function createFloatingButton()
    local localPlayer = Players.LocalPlayer
    if not localPlayer then return end
    local playerGui = localPlayer:FindFirstChild("PlayerGui")
    if not playerGui then return end
    
    if UI_STATE.floatBtn and UI_STATE.floatBtn:IsDescendantOf(game) then
        return
    end
    
    local floatGui = Instance.new("ScreenGui")
    floatGui.Name = "TXRè„šæœ¬æ‚¬æµ®çª—"
    floatGui.IgnoreGuiInset = true
    floatGui.Parent = playerGui
    
    -- å¿è€…æ³¨å…¥å™¨ä¿æŠ¤GUI
    pcall(function()
        if syn and syn.protect_gui then
            syn.protect_gui(floatGui)
        end
    end)
    
    local floatWidth = 60 * UI_STATE.scale
    local floatHeight = 30 * UI_STATE.scale
    UI_STATE.floatBtn = createUIButton(floatGui, {
        name = "FloatingButton",
        size = UDim2.new(0, floatWidth, 0, floatHeight),
        position = UDim2.new(1, -floatWidth - 2, 0.1, 0),
        text = "æ˜¾ç¤º",
        bgColor = CONFIG.UI_COLORS.primary,
        radius = 15 * UI_STATE.scale,
        textSize = 14,
        hoverColor = Color3.fromRGB(70, 70, 120),
        onClick = function()
            if UI_STATE.mainPanel then
                local isVisible = UI_STATE.mainPanel.Visible
                UI_STATE.mainPanel.Visible = not isVisible
                if UI_STATE.floatBtn and UI_STATE.floatBtn:IsDescendantOf(game) then
                    UI_STATE.floatBtn.Text = isVisible and "æ˜¾ç¤º" or "éšè—"
                end
                showNotification("ä¸»UIçŠ¶æ€", "å·²" .. (isVisible and "éšè—" or "æ˜¾ç¤º") .. "åŠŸèƒ½é¢æ¿")
            else
                createMainUI()
                if UI_STATE.floatBtn and UI_STATE.floatBtn:IsDescendantOf(game) then
                    UI_STATE.floatBtn.Text = "éšè—"
                    showNotification("ä¸»UIåŠ è½½å®Œæˆ", "åŠŸèƒ½é¢æ¿å·²æ˜¾ç¤º")
                end
            end
        end
    })
    
    -- æ‚¬æµ®çª—æ‹–åŠ¨é€»è¾‘
    local btnIsDragging = false
    local btnStartPos = UI_STATE.floatBtn and UI_STATE.floatBtn.Position or UDim2.new()
    
    if UI_STATE.floatBtn then
        UI_STATE.floatBtn.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or 
               input.UserInputType == Enum.UserInputType.Touch then
                btnIsDragging = true
                UI_STATE.dragStart = input.Position
                btnStartPos = UI_STATE.floatBtn.Position
            end
        end)
    end
    
    UserInputService.InputChanged:Connect(function(input)
        if btnIsDragging and (input.UserInputType == Enum.UserInputType.MouseMovement or 
           input.UserInputType == Enum.UserInputType.Touch) and UI_STATE.floatBtn and UI_STATE.floatBtn:IsDescendantOf(game) then
            local delta = input.Position - UI_STATE.dragStart
            UI_STATE.floatBtn.Position = UDim2.new(
                btnStartPos.X.Scale, btnStartPos.X.Offset + delta.X,
                btnStartPos.Y.Scale, btnStartPos.Y.Offset + delta.Y
            )
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if (input.UserInputType == Enum.UserInputType.MouseButton1 or 
            input.UserInputType == Enum.UserInputType.Touch) and btnIsDragging then
            btnIsDragging = false
        end
    end)
    
    print("æ‚¬æµ®çª—åˆ›å»ºæˆåŠŸ")
end

-- ====================== èœå•å†…å®¹åˆ›å»ºå‡½æ•° ======================
local function create1Content(container)
    if not container or not container:IsDescendantOf(game) then return function() end end
    
    local coordDisplay = Instance.new("Frame")
    coordDisplay.Name = "CoordDisplay"
    coordDisplay.Size = UDim2.new(1, 0, 0, 40 * UI_STATE.scale)
    coordDisplay.LayoutOrder = 1
    coordDisplay.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
    coordDisplay.BackgroundTransparency = 0.7
    coordDisplay.Parent = container
    createCorner(coordDisplay, 6)
    
    local coordLabel = createUILabel(coordDisplay, {
        size = UDim2.new(1, -10 * UI_STATE.scale, 1, 0),
        position = UDim2.new(0, 10 * UI_STATE.scale, 0, 0),
        text = "å®æ—¶åæ ‡ï¼šX: ---, Y: ---, Z: ---",
        textSize = 14,
        xAlign = Enum.TextXAlignment.Left
    })
    
    local nameInput = Instance.new("TextBox")
    nameInput.Name = "NameInput"
    nameInput.Size = UDim2.new(1, 0, 0, 40 * UI_STATE.scale)
    nameInput.LayoutOrder = 2
    nameInput.PlaceholderText = "è¾“å…¥åæ ‡åç§°"
    nameInput.Text = ""
    nameInput.TextColor3 = Color3.new(1, 1, 1)
    nameInput.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
    nameInput.TextSize = 14 * UI_STATE.scale
    nameInput.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
    nameInput.BackgroundTransparency = 0.7
    nameInput.Parent = container
    nameInput.Active = true
    nameInput.Selectable = true
    createCorner(nameInput, 6)
    
    -- æ“ä½œæç¤º
    nameInput.FocusLost:Connect(function(enterPressed)
        if enterPressed and nameInput.Text ~= "" then
            showNotification("åç§°å·²æ›´æ–°", "åæ ‡åç§°è®¾ç½®ä¸ºï¼š" .. nameInput.Text)
        end
    end)
    
    createUIButton(container, {
        name = "SaveBtn",
        layoutOrder = 3,
        text = "ä¿å­˜åˆ°æ–‡ä»¶",
        bgColor = CONFIG.UI_COLORS.success,
        hoverColor = Color3.fromRGB(70, 110, 90),
        onClick = function()
            local player = Players.LocalPlayer
            local rootPart = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if not rootPart then
                showNotification("ä¿å­˜å¤±è´¥", "è§’è‰²æœªåŠ è½½")
                return
            end
            
            local name = nameInput.Text ~= "" and nameInput.Text or "æœªå‘½ååæ ‡"
            local exists = false
            for _, item in ipairs(UI_STATE.savedCoordinates) do
                if item.name == name then exists = true end
            end
            if exists then name = name .. "(" .. #UI_STATE.savedCoordinates + 1 .. ")" end
            
            local pos = rootPart.Position
            local x, y, z = math.round(pos.X*100)/100, math.round(pos.Y*100)/100, math.round(pos.Z*100)/100
            table.insert(UI_STATE.savedCoordinates, {name = name, x = x, y = y, z = z})
            
            local success = updateCSVFile()
            showNotification(
                success and "ä¿å­˜æˆåŠŸ" or "ä¿å­˜å¤±è´¥",
                success and ("å·²ä¿å­˜åˆ°ï¼š" .. UI_STATE.csvFilePath) or "æ³¨å…¥å™¨ä¸æ”¯æŒæ–‡ä»¶å†™å…¥"
            )
            nameInput.Text = ""
        end
    })
    
    return function(isVisible)
        if not isVisible then return end
        if UI_STATE.coordinateLoop then UI_STATE.coordinateLoop:Disconnect() end
        
        UI_STATE.coordinateLoop = RunService.Heartbeat:Connect(function()
            if not coordLabel or not coordLabel:IsDescendantOf(game) then
                return
            end
            
            local player = Players.LocalPlayer
            if not player then return end
            
            local character = player.Character
            if not character then
                coordLabel.Text = "å®æ—¶åæ ‡ï¼šè§’è‰²æœªç”Ÿæˆ"
                return
            end
            
            local rootPart = character:FindFirstChild("HumanoidRootPart")
            if rootPart then
                local pos = rootPart.Position
                coordLabel.Text = string.format("å®æ—¶åæ ‡ï¼šX: %.1f, Y: %.1f, Z: %.1f", pos.X, pos.Y, pos.Z)
            else
                coordLabel.Text = "å®æ—¶åæ ‡ï¼šè§’è‰²åŠ è½½ä¸­..."
            end
        end)
    end
end

-- å…¶ä»–èœå•å†…å®¹å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦å®Œæ•´å®ç°ï¼‰
local function create2Content(container)
    if not container or not container:IsDescendantOf(game) then return function() end end
    
    createUILabel(container, {
        text = "ç©å®¶ä¼ é€åŠŸèƒ½",
        size = UDim2.new(1, 0, 0, 40 * UI_STATE.scale),
        layoutOrder = 1,
        textSize = 16,
        xAlign = Enum.TextXAlignment.Center
    })
    
    return function() end
end

local function create3Content(container)
    if not container or not container:IsDescendantOf(game) then return function() end end
    
    createUILabel(container, {
        text = "æ³¨å…¥å™¨ä¸‹è½½",
        size = UDim2.new(1, 0, 0, 40 * UI_STATE.scale),
        layoutOrder = 1,
        textSize = 16,
        xAlign = Enum.TextXAlignment.Center
    })
    
    return function() end
end

-- ====================== ä¸»UIåˆ›å»º ======================
local function createMainUI()
    cleanupOldUI()
    UI_STATE.isScaling = true
    
    local localPlayer = Players.LocalPlayer
    if not localPlayer then
        warn("æ— æ³•è·å–æœ¬åœ°ç©å®¶")
        showNotification("UIåŠ è½½å¤±è´¥", "æ— æ³•è·å–æœ¬åœ°ç©å®¶", 10)
        return
    end
    
    local playerGui = localPlayer:WaitForChild("PlayerGui", 10)
    if not playerGui then
        warn("è·å–PlayerGuiè¶…æ—¶")
        showNotification("UIåŠ è½½å¤±è´¥", "è·å–PlayerGuiè¶…æ—¶", 10)
        return
    end
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "TXRè„šæœ¬"
    screenGui.IgnoreGuiInset = true
    screenGui.Parent = playerGui
    
    -- å¿è€…æ³¨å…¥å™¨ä¿æŠ¤GUI
    pcall(function()
        if syn and syn.protect_gui then
            syn.protect_gui(screenGui)
        end
    end)
    
    local mainPanel = Instance.new("Frame")
    mainPanel.Name = "MainPanel"
    mainPanel.Size = UDim2.new(0, 650 * UI_STATE.scale, 0, 380 * UI_STATE.scale)
    mainPanel.Position = UDim2.new(0.5, -325 * UI_STATE.scale, 0.5, -190 * UI_STATE.scale)
    mainPanel.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    mainPanel.BackgroundTransparency = 0.9
    mainPanel.BorderSizePixel = 1
    mainPanel.BorderColor3 = Color3.fromRGB(180, 160, 255)
    mainPanel.Parent = screenGui
    createCorner(mainPanel, 14)
    
    UI_STATE.mainPanel = mainPanel
    
    -- åˆ›å»ºé¡¶éƒ¨æ 
    local topBar = Instance.new("Frame")
    topBar.Name = "TopBar"
    topBar.Size = UDim2.new(1, -20 * UI_STATE.scale, 0, 80 * UI_STATE.scale)
    topBar.Position = UDim2.new(0, 10 * UI_STATE.scale, 0, 10 * UI_STATE.scale)
    topBar.BackgroundColor3 = Color3.fromRGB(50, 50, 80)
    topBar.BackgroundTransparency = 0.8
    topBar.Parent = mainPanel
    createCorner(topBar, 8)
    
    UI_STATE.topBar = topBar
    
    -- æ ‡é¢˜
    createUILabel(topBar, {
        name = "TitleLabel",
        size = UDim2.new(0, 0, 1, 0),
        position = UDim2.new(0.5, 0, 0, 0),
        anchor = Vector2.new(0.5, 0),
        text = "TXRè„šæœ¬ UI 2.0",
        color = CONFIG.UI_COLORS.accent,
        textSize = 26,
        font = Enum.Font.SourceSansBold,
        xAlign = Enum.TextXAlignment.Center
    })
    
    -- æ§åˆ¶æŒ‰é’®
    local function createControlButton(text, offset, color, callback)
        createUIButton(topBar, {
            name = text == "X" and "CloseBtn" or (text == "+" and "ZoomInBtn" or "ZoomOutBtn"),
            size = UDim2.new(0, 36 * UI_STATE.scale, 0, 36 * UI_STATE.scale),
            position = UDim2.new(1, -45 * UI_STATE.scale - offset, 0.5, 0),
            anchor = Vector2.new(0.5, 0.5),
            text = text,
            textSize = 18,
            bgColor = color,
            radius = 6,
            hoverColor = text == "X" and Color3.fromRGB(230, 80, 80) or 
                        (text == "+" and Color3.fromRGB(80, 140, 80) or Color3.fromRGB(140, 100, 80)),
            onClick = callback
        })
    end
    
    -- ç¼©å°æŒ‰é’®
    createControlButton("-", 90 * UI_STATE.scale, Color3.fromRGB(120, 80, 60), function()
        if UI_STATE.isScaling then return end
        UI_STATE.isScaling = true
        
        local currentActiveMenu = UI_STATE.activeMenu
        if UI_STATE.scale > 0.6 then
            UI_STATE.scale = UI_STATE.scale - 0.1
            cleanupOldUI()
            UI_STATE.activeMenu = currentActiveMenu
            createMainUI()
            showNotification("UIç¼©æ”¾è°ƒæ•´", "å½“å‰ç¼©æ”¾æ¯”ä¾‹ï¼š" .. string.format("%.1f", UI_STATE.scale) .. "xï¼ˆç¼©å°ï¼‰")
        else
            showNotification("ç¼©æ”¾é™åˆ¶", "å·²è¾¾åˆ°æœ€å°ç¼©æ”¾æ¯”ä¾‹ï¼ˆ0.6xï¼‰", 2)
            UI_STATE.isScaling = false
        end
    end)
    
    -- æ”¾å¤§æŒ‰é’®
    createControlButton("+", 45 * UI_STATE.scale, Color3.fromRGB(60, 120, 60), function()
        if UI_STATE.isScaling then return end
        UI_STATE.isScaling = true
        
        local currentActiveMenu = UI_STATE.activeMenu
        if UI_STATE.scale < 1.0 then
            UI_STATE.scale = UI_STATE.scale + 0.1
            cleanupOldUI()
            UI_STATE.activeMenu = currentActiveMenu
            createMainUI()
            showNotification("UIç¼©æ”¾è°ƒæ•´", "å½“å‰ç¼©æ”¾æ¯”ä¾‹ï¼š" .. string.format("%.1f", UI_STATE.scale) .. "xï¼ˆæ”¾å¤§ï¼‰")
        else
            showNotification("ç¼©æ”¾é™åˆ¶", "å·²è¾¾åˆ°æœ€å¤§ç¼©æ”¾æ¯”ä¾‹ï¼ˆ1.0xï¼‰", 2)
            UI_STATE.isScaling = false
        end
    end)
    
    -- å…³é—­æŒ‰é’®
    createControlButton("X", 0, Color3.fromRGB(210, 60, 60), function()
        cleanupOldUI()
        UI_STATE.isRunning = false
        showNotification("è„šæœ¬å·²å…³é—­", "TXRè„šæœ¬å·²é€€å‡ºè¿è¡Œ", 3)
    end)
    
    -- ç»‘å®šæ‹–åŠ¨äº‹ä»¶
    bindDragToElement(topBar, mainPanel)
    bindDragToElement(mainPanel, mainPanel)
    
    UserInputService.InputChanged:Connect(function(input)
        if UI_STATE.isDragging and not UI_STATE.isScrolling and 
           (input.UserInputType == Enum.UserInputType.MouseMovement or 
            input.UserInputType == Enum.UserInputType.Touch) and
           mainPanel:IsDescendantOf(game) then
            local delta = input.Position - UI_STATE.dragStart
            mainPanel.Position = UDim2.new(
                UI_STATE.panelStartPos.X.Scale, UI_STATE.panelStartPos.X.Offset + delta.X,
                UI_STATE.panelStartPos.Y.Scale, UI_STATE.panelStartPos.Y.Offset + delta.Y
            )
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if (input.UserInputType == Enum.UserInputType.MouseButton1 or 
            input.UserInputType == Enum.UserInputType.Touch) and UI_STATE.isDragging then
            UI_STATE.isDragging = false
        end
    end)
    
    createFloatingButton()
    UI_STATE.isScaling = false
    print("ä¸»UIåˆ›å»ºæˆåŠŸ")
end

-- ====================== è„šæœ¬åˆå§‹åŒ– ======================
local function initScript()
    local localPlayer = Players.LocalPlayer
    if not localPlayer then
        localPlayer = Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
        if not localPlayer then
            warn("æ— æ³•è·å–æœ¬åœ°ç©å®¶")
            return
        end
    end
    
    initCSVPath()
    
    -- åˆå§‹åŒ–è§’è‰²ç›‘å¬
    if UI_STATE.characterAddedConn then
        UI_STATE.characterAddedConn:Disconnect()
    end
    if UI_STATE.characterRemovingConn then
        UI_STATE.characterRemovingConn:Disconnect()
    end
    
    -- ç›‘å¬è§’è‰²æ·»åŠ 
    UI_STATE.characterAddedConn = localPlayer.CharacterAdded:Connect(onCharacterAdded)
    -- ç›‘å¬è§’è‰²ç§»é™¤
    UI_STATE.characterRemovingConn = localPlayer.CharacterRemoving:Connect(onCharacterRemoving)
    
    -- å¦‚æœå·²æœ‰è§’è‰²ï¼Œç«‹å³åˆå§‹åŒ–
    if localPlayer.Character then
        task.spawn(onCharacterAdded, localPlayer.Character)
    end
    
    UI_STATE.savedCoordinates = readCSVFile()
    
    local success, err = pcall(createMainUI)
    if not success then
        local fullError = debug.traceback(err)
        warn("åˆ›å»ºUIå¤±è´¥ï¼š\n" .. fullError)
        showNotification("UIåŠ è½½å¤±è´¥", "é”™è¯¯ï¼š" .. tostring(err):sub(1, 100), 10)
    else
        showNotification("UI 2.0åŠ è½½æˆåŠŸ", "å°Šè´µçš„ç”¨æˆ·æ¬¢è¿ä½¿ç”¨TXRè„šæœ¬", 3)
        print("åˆå§‹åŒ–å®Œæˆ")
    end
end

-- ====================== è„šæœ¬å¯åŠ¨ ======================
local success, errorMsg = pcall(initScript)
if not success then
    local fullError = debug.traceback(errorMsg)
    warn("è„šæœ¬å¯åŠ¨å¤±è´¥ï¼š\n" .. fullError)
    
    pcall(function()
        local player = Players.LocalPlayer
        if player and player:FindFirstChild("PlayerGui") then
            local gui = Instance.new("ScreenGui")
            gui.Parent = player.PlayerGui
            
            pcall(function()
                if syn and syn.protect_gui then
                    syn.protect_gui(gui)
                end
            end)
            
            createUILabel(gui, {
                name = "ErrorLabel",
                size = UDim2.new(1, 0, 1, 0),
                text = "è„šæœ¬å¯åŠ¨å¤±è´¥ï¼š\n" .. tostring(errorMsg):sub(1, 200),
                color = Color3.new(1, 0, 0),
                textSize = 14,
                textWrapped = true,
                xAlign = Enum.TextXAlignment.Left
            })
        end
    end)
end